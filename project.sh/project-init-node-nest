#!/bin/bash

# http://redsymbol.net/articles/unofficial-bash-strict-mode/
set -euo pipefail
IFS=$'\n\t'


# create files from template
nix flake new -t github:Samayel/qnixpkgs#node-nest-project .

rm -f package.json.example

# create flake.lock
nix flake metadata >/dev/null

# initialize direnv
direnv allow


# setup typescript, gulp, webpack, sass, express and nest
cat >__stage2 <<EOF
#! /usr/bin/env -S nix shell qnixpkgs#bash qnixpkgs#coreutils qnixpkgs#jq . -i -c bash

npm init -y

npm i -D typescript ts-node @types/node @tsconfig/node18-strictest-esm \
         gulp gulp-typescript del \
         webpack webpack-cli ts-loader html-webpack-plugin \
         style-loader css-loader mini-css-extract-plugin \
         node-sass sass-loader \
         less less-loader \
         husky lint-staged prettier \
         nodemon \
         npm-run-all \
         @types/express @types/express-ejs-layouts @types/config @types/jest

npm i express express-ejs-layouts ejs \
      @nestjs/core @nestjs/common @nestjs/platform-express @nestjs/testing rxjs reflect-metadata \
      config properties

function __update_package_json() {
  cat package.json | jq "\$@" >package.json2 ; mv package.json2 package.json
}

__update_package_json '.main = "./src/backend/app.ts"'
__update_package_json '.type = "module"'

__update_package_json '.scripts."prepare" = "husky install"'
__update_package_json '.scripts."prettify" = "npx prettier --write src"'
__update_package_json '.scripts."clean" = "npx gulp clean"'
__update_package_json '.scripts."build_backend" = "npx gulp backend"'
__update_package_json '.scripts."build_frontend_assets" = "npx gulp frontend-assets"'
__update_package_json '.scripts."build_frontend_views" = "npx gulp frontend-views"'
__update_package_json '.scripts."build_frontend_compile:dev" = "npx webpack --mode development"'
__update_package_json '.scripts."build_frontend_compile:prod" = "npx webpack --mode production"'
__update_package_json '.scripts."build_frontend:dev" = "npx run-p build_frontend_assets build_frontend_views build_frontend_compile:dev"'
__update_package_json '.scripts."build_frontend:prod" = "npx run-p build_frontend_assets build_frontend_views build_frontend_compile:prod"'
__update_package_json '.scripts."build:dev" = "npm run clean && npx run-p build_backend build_frontend:dev"'
__update_package_json '.scripts."build:prod" = "npm run clean && npx run-p build_backend build_frontend:prod"'
__update_package_json '.scripts."serve:dev" = "NODE_ENV=development node --experimental-specifier-resolution=node ./dist/backend/app.js"'
__update_package_json '.scripts."serve:prod" = "NODE_ENV=production node --experimental-specifier-resolution=node ./dist/backend/app.js"'
__update_package_json '.scripts."build_serve:dev" = "npx run-s build:dev serve:dev"'
__update_package_json '.scripts."build_serve:prod" = "npx run-s build:prod serve:prod"'
__update_package_json '.scripts."watch_backend" = "npx nodemon --watch config --watch src/backend -e ts,tsx,cts,mts,js,jsx,cjs,mjs,json,properties --exec npx run-s build_backend serve:dev"'
__update_package_json '.scripts."watch_frontend_assets" = "npx nodemon --watch src/frontend/static -e svg,webp,gif,jpg,jpeg,png,woff,ttf,otf,webm,avi,mp4,mpg,mpeg,mkv,weba,wav,mp3,aac,ogg,flac,pdf,txt,rtf,doc,docx,xls,xlsx,ppt,pptx,odt,ods,odp,json --exec npm run build_frontend_assets"'
__update_package_json '.scripts."watch_frontend_views" = "npx nodemon --watch src/frontend/views -e ejs,html,htm --exec npm run build_frontend_views"'
__update_package_json '.scripts."watch_frontend_compile" = "npx nodemon --watch src/frontend/static -e ts,tsx,cts,mts,js,jsx,cjs,mjs,css,scss,sass,less --exec npm run build_frontend_compile:dev"'
__update_package_json '.scripts."watch" = "npm run clean && npx run-p watch_backend watch_frontend_assets watch_frontend_views watch_frontend_compile"'
__update_package_json '.scripts."dev" = "npm run watch"'
__update_package_json '.scripts."prod" = "npm run build_serve:prod"'

npm run prepare
npx husky add .husky/pre-commit "npx lint-staged"
EOF

chmod +x __stage2
./__stage2
rm -f __stage2


# initialize git
git init
git add .
